name: Docker Deploy to EC2

on:
  push:
    branches:
      - prod   # prod ë¸Œëœì¹˜ì— push ë  ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            set -e
            
            # Docker ê¶Œí•œ ë¬¸ì œ í•´ê²°
            sudo usermod -aG docker ubuntu
            sudo chmod 666 /var/run/docker.sock
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
            sudo mkdir -p /opt/mercury-kis-open-trading-api
            sudo chown -R ubuntu:ubuntu /opt/mercury-kis-open-trading-api
            cd /opt/mercury-kis-open-trading-api
            
            # Git ì €ì¥ì†Œê°€ ì—†ìœ¼ë©´ í´ë¡ 
            if [ ! -d ".git" ]; then
              echo "Git ì €ì¥ì†Œ í´ë¡  ì¤‘..."
              git clone git@wwbrdle:wwbrdle/mercury-kis-open-trading-api.git .
              git checkout prod
            else
              echo "Git ì €ì¥ì†Œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
              git fetch --all
              git reset --hard origin/prod
            fi
            
            # ë””ìŠ¤í¬ ê³µê°„ ì •ë¦¬ (ìµœì í™”ëœ ì •ë¦¬)
            echo "ğŸ§¹ Docker ì‹œìŠ¤í…œ ì •ë¦¬ ì‹œì‘..."
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ“¦ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            sudo docker container prune -f
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ–¼ï¸ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            sudo docker image prune -a -f
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬
            echo "ğŸŒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ ì¤‘..."
            sudo docker network prune -f
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
            echo "ğŸ’¾ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ ì¤‘..."
            sudo docker volume prune -f
            
            # ë¹Œë“œ ìºì‹œ ì •ë¦¬
            echo "ğŸ—‘ï¸ ë¹Œë“œ ìºì‹œ ì •ë¦¬ ì¤‘..."
            sudo docker builder prune -a -f
            
            # ì‹œìŠ¤í…œ ì „ì²´ ì •ë¦¬
            echo "ğŸ§½ ì‹œìŠ¤í…œ ì „ì²´ ì •ë¦¬ ì¤‘..."
            sudo docker system prune -a -f
            
            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
            echo "ğŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸:"
            df -h
            echo "ğŸ“Š Docker ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
            sudo docker system df
            
            # ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± ì²´í¬
            available_space=$(df / | awk 'NR==2 {print $4}')
            if [ "$available_space" -lt 1000000 ]; then  # 1GB ë¯¸ë§Œ
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: ë””ìŠ¤í¬ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì‚¬ìš© ê°€ëŠ¥: ${available_space}KB)"
              echo "ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ìƒì„¸:"
              df -h
              exit 1
            fi
            echo "âœ… ë””ìŠ¤í¬ ê³µê°„ ì¶©ë¶„: ${available_space}KB ì‚¬ìš© ê°€ëŠ¥"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ (ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            sudo docker ps --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}"
            
            # Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸ ë° ìƒì„±
            echo "Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘..."
            if ! sudo docker network ls | grep -q "mercury_mercury-network"; then
              echo "mercury_mercury-network ë„¤íŠ¸ì›Œí¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
              sudo docker network create mercury_mercury-network
            else
              echo "mercury_mercury-network ë„¤íŠ¸ì›Œí¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi
            
            # ìµœì í™”ëœ Docker ë¹Œë“œ ë° ì‹¤í–‰
            echo "ğŸš€ ìµœì í™”ëœ Docker ë¹Œë“œ ì‹œì‘..."
            
            # ê¸°ì¡´ mercury-kis-open-trading-api ì´ë¯¸ì§€ ì œê±°
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±° ì¤‘..."
            sudo docker rmi mercury-kis-open-trading-api:latest 2>/dev/null || true
            
            # ë¹Œë“œ ì „ ì¶”ê°€ ì •ë¦¬
            echo "ğŸ§¹ ë¹Œë“œ ì „ ì¶”ê°€ ì •ë¦¬ ì¤‘..."
            sudo docker builder prune -a -f
            sudo rm -rf /tmp/docker-* 2>/dev/null || true
            
            # ìµœì í™”ëœ ë¹Œë“œ ì‹¤í–‰
            echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            if ! sudo docker build \
                --no-cache \
                --compress \
                --memory=2g \
                --memory-swap=4g \
                --progress=plain \
                -t mercury-kis-open-trading-api:latest .; then
                echo "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨!"
                echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
                echo "1. ë””ìŠ¤í¬ ê³µê°„ í™•ì¸"
                echo "2. Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
                echo "3. ë¹Œë“œ ë¡œê·¸ í™•ì¸"
                exit 1
            fi
            
            echo "âœ… Docker ë¹Œë“œ ì„±ê³µ!"
            
            # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
            echo "ğŸ“Š ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´:"
            sudo docker images mercury-kis-open-trading-api:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸƒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            if ! sudo docker compose up -d mercury-kis-open-trading-api; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨!"
                echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                sudo docker compose logs mercury-kis-open-trading-api
                exit 1
            fi
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            sudo docker compose ps
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ ê²€ì¦
            echo "ğŸ” ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ ê²€ì¦ ì¤‘..."
            echo "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ëª©ë¡:"
            sudo docker ps --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}"
            
            # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            if ! sudo docker ps --format "{{.Names}}" | grep -q "mercury-kis-open-trading-api"; then
                echo "âŒ ë°°í¬ ì‹¤íŒ¨: mercury-kis-open-trading-api ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                echo "ëª¨ë“  ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
                sudo docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                sudo docker compose logs mercury-kis-open-trading-api
                exit 1
            fi
            
            # ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
            
            # ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ ì¶”ê°€ í™•ì¸
            sleep 10  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            if ! sudo docker ps --format "{{.Names}}" | grep -q "mercury-kis-open-trading-api"; then
                echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ í›„ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
                echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                sudo docker compose logs --tail=50 mercury-kis-open-trading-api
                exit 1
            fi
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            for i in {1..12}; do
              echo "ì‹œë„ $i/12: heartbeat API í™•ì¸ ì¤‘..."
              if curl -f -s http://localhost:8000/heartbeat > /dev/null 2>&1; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
                break
              else
                echo "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 5ì´ˆ í›„ ì¬ì‹œë„..."
                sleep 5
              fi
              
              if [ $i -eq 12 ]; then
                echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ 60ì´ˆ ë‚´ì— ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                sudo docker compose logs --tail=50 mercury-kis-open-trading-api
                exit 1
              fi
            done
              
            # ìµœì¢… heartbeat í™•ì¸
            echo "ğŸ” ìµœì¢… heartbeat í™•ì¸ ì¤‘..."
            heartbeat_response=$(curl -s http://localhost:8000/heartbeat)
            if [ $? -ne 0 ] || ! echo "$heartbeat_response" | grep -q "heartbeat_ok"; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: heartbeat APIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "Heartbeat ì‘ë‹µ:"
              echo "$heartbeat_response"
              echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
              sudo docker compose logs --tail=50 mercury-kis-open-trading-api
              exit 1
            fi
            
            echo "âœ… ë°°í¬ ì„±ê³µ: mercury-kis-open-trading-apiê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            echo "ì»¨í…Œì´ë„ˆ ì •ë³´:"
            sudo docker ps --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}" | grep mercury-kis-open-trading-api
            echo "Heartbeat ì‘ë‹µ:"
            echo "$heartbeat_response"
            
            # ì¶”ê°€ API í…ŒìŠ¤íŠ¸ (KIS API ì—°ê²° í™•ì¸)
            echo "ğŸ” KIS API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
            api_response=$(curl -s http://localhost:8000/uapi/domestic-stock/v1/ranking/fluctuation)
            if echo "$api_response" | grep -q "EGW00123"; then
              echo "âš ï¸ ê²½ê³ : KIS API í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í† í° ê°±ì‹ ì´ í•„ìš”í•©ë‹ˆë‹¤."
              echo "API ì‘ë‹µ:"
              echo "$api_response"
            elif echo "$api_response" | grep -q "error\|Error\|ERROR"; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: KIS API ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
              echo "API ì‘ë‹µ:"
              echo "$api_response"
              exit 1
            else
              echo "âœ… KIS API ì—°ê²° ì •ìƒ"
            fi
            
            # ë¡œê·¸ í™•ì¸
            sudo docker compose logs --tail=50

